<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#7c2d12">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎃 Spooky Sliding Puzzle 👻</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* 原有的动画定义保持不变 */
        @keyframes float {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
            }

            25% {
                transform: translateY(-20px) rotate(5deg);
            }

            50% {
                transform: translateY(-40px) rotate(-5deg);
            }

            75% {
                transform: translateY(-20px) rotate(3deg);
            }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 107, 53, 0.5), 0 0 40px rgba(255, 107, 53, 0.3);
            }

            50% {
                box-shadow: 0 0 40px rgba(255, 107, 53, 0.8), 0 0 60px rgba(255, 107, 53, 0.5);
            }
        }

        @keyframes shake {
            0%, 100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-3deg);
            }

            75% {
                transform: rotate(3deg);
            }
        }

        @keyframes bloodSlide {
            0% {
                box-shadow: 0 0 0 rgba(139, 0, 0, 0);
            }

            50% {
                box-shadow: 0 0 30px rgba(139, 0, 0, 0.8), 0 0 50px rgba(220, 20, 60, 0.6);
            }

            100% {
                box-shadow: 0 0 0 rgba(139, 0, 0, 0);
            }
        }

        .blood-slide {
            animation: bloodSlide 0.3s ease-out;
        }

        /* 修复滚动问题 */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* 改善移动端滚动体验 */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(to bottom right, #7c2d12, #4c1d95, #000000);
            min-height: 100%;
        }

        #root {
            min-height: 100%;
            width: 100%;
        }

        /* 游戏板内允许垂直滚动但禁止水平滚动 */
        .puzzle-container {
            overflow-y: auto;
            overflow-x: hidden; /* 禁止水平滚动 */
            -webkit-overflow-scrolling: touch;
            max-height: 90vh; /* 增加最大高度，使纵向内容更多 */
        }

        /* 游戏板本身禁止任何滚动 */
        .puzzle-board {
            overflow: hidden;
            touch-action: pan-y; /* 只允许垂直方向的手势 */
        }

        /* 移动端性能优化 */
        @media (max-width: 768px) {
            .blood-slide {
                animation: bloodSlide 0.2s ease-out;
            }

            /* 禁用部分动画以减少闪烁 */
            .animate-pulse {
                animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }

            /* 使用标准CSS替代Tailwind伪类 */
            .tile-hover-disable:hover {
                transform: none !important;
            }

            /* 移动端减少容器高度，确保可以滚动 */
            .puzzle-container {
                max-height: 85vh; /* 增加移动端最大高度 */
            }

            /* 移动端游戏板尺寸自适应 */
            .puzzle-board {
                width: 100%;
                max-width: 100vw;
            }
        }

        /* 硬件加速 */
        .gpu-accelerated {
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }

        /* 防止文本选择 - 移除过时前缀 */
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* 移动端激活状态 */
        .tile-active:active {
            transform: scale(0.95) rotate(2deg);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // 完全移除触摸事件阻止，允许所有滚动
    // 防止页面休眠
    let keepAliveTimer;
    function keepPageAlive() {
      if (document.hidden) return;
      keepAliveTimer = setTimeout(keepPageAlive, 30000);
    }
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        keepPageAlive();
      } else {
        clearTimeout(keepAliveTimer);
      }
    });
    keepPageAlive();

    // ═══════════════════════════════════════════════════════════════════════
    // 🔥 FIREBASE CONFIGURATION
    // ═══════════════════════════════════════════════════════════════════════

    const firebaseConfig = {
    apiKey: "AIzaSyCdyeAVxETu5upcMAIWIKi5ykuqcuhSDXk",
    authDomain: "spooky-puzzle-game-7dcf4.firebaseapp.com",
    projectId: "spooky-puzzle-game-7dcf4",
    storageBucket: "spooky-puzzle-game-7dcf4.firebasestorage.app",
    messagingSenderId: "838626431807",
    appId: "1:838626431807:web:c0c6e5d151e395f3e8b98a"
    };

    // 保存游戏状态到本地存储
    function saveGameState(state) {
        try {
            localStorage.setItem('spooky_puzzle_state', JSON.stringify(state));
        } catch (e) {
            console.log('Could not save game state');
        }
    }

    // 从本地存储加载游戏状态
    function loadGameState() {
        try {
            const saved = localStorage.getItem('spooky_puzzle_state');
            return saved ? JSON.parse(saved) : null;
        } catch (e) {
            return null;
        }
    }

    // Initialize Firebase
    let db = null;
    let firebaseInitialized = false;

    try {
      if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        firebaseInitialized = true;
        console.log("✅ Firebase initialized successfully! Global leaderboard is active.");
      } else {
        console.log("⚠️ Firebase not configured. Using local storage only.");
        console.log("📝 To enable global leaderboard, update the firebaseConfig in the HTML file.");
      }
    } catch (error) {
      console.error("❌ Firebase initialization error:", error);
      console.log("📝 Using local storage fallback.");
    }

    function SlidingPuzzle() {
      const [isMobile, setIsMobile] = useState(false);
      const saveGameStateDebounced = useRef(null);
      const [tiles, setTiles] = useState([0, 1, 2, 3, 4, 5, 6, 7, 8]);
      const [moves, setMoves] = useState(0);
      const [image, setImage] = useState(null);
      const [isWon, setIsWon] = useState(false);
      const [floatingIcons, setFloatingIcons] = useState([]);
      const [playerName, setPlayerName] = useState('');
      const [showNameInput, setShowNameInput] = useState(false);
      const [leaderboard, setLeaderboard] = useState([]);
      const [showLeaderboard, setShowLeaderboard] = useState(false);
      const [startTime, setStartTime] = useState(null);
      const [completionTime, setCompletionTime] = useState(0);
      const [animatingTile, setAnimatingTile] = useState(null);
      const fileInputRef = useRef(null);
      const puzzleBoardRef = useRef(null);

      // 检测屏幕尺寸并调整游戏板大小
      useEffect(() => {
        const checkScreenSize = () => {
          const mobile = window.innerWidth < 768;
          setIsMobile(mobile);

          // 如果是移动设备，调整游戏板大小
          if (mobile && puzzleBoardRef.current) {
            const container = puzzleBoardRef.current.parentElement;
            const containerWidth = container.clientWidth;

            // 设置游戏板宽度为容器宽度减去内边距
            const boardSize = containerWidth - 32; // 减去内边距
            puzzleBoardRef.current.style.width = `${boardSize}px`;
            puzzleBoardRef.current.style.height = `${boardSize}px`;
          }
        };

        checkScreenSize();
        window.addEventListener('resize', checkScreenSize);

        return () => {
          window.removeEventListener('resize', checkScreenSize);
        };
      }, []);

      // 防抖保存游戏状态
      useEffect(() => {
        if (saveGameStateDebounced.current) {
          clearTimeout(saveGameStateDebounced.current);
        }

        saveGameStateDebounced.current = setTimeout(() => {
          const gameState = {
            tiles,
            moves,
            image,
            startTime,
            completionTime
          };
          saveGameState(gameState);
          saveGameStateDebounced.current = null;
        }, 500);

        return () => {
          if (saveGameStateDebounced.current) {
            clearTimeout(saveGameStateDebounced.current);
          }
        };
      }, [tiles, moves, image, startTime, completionTime]);

      // 组件挂载时加载保存的状态
      useEffect(() => {
        const savedState = loadGameState();
        if (savedState) {
          setTiles(savedState.tiles || [0,1,2,3,4,5,6,7,8]);
          setMoves(savedState.moves || 0);
          setImage(savedState.image || null);
          setStartTime(savedState.startTime || null);
          setCompletionTime(savedState.completionTime || 0);
        }

        // 加载排行榜
        loadLeaderboard();
      }, []);

      // 减少浮动图标数量（移动端）
      useEffect(() => {
        const isMobile = window.innerWidth < 768;
        const totalIcons = isMobile ? 10 : 20; // 进一步减少图标数量

        const icons = ['👻', '🎃', '🦇', '🕷️', '💀', '🕸️', '🐈‍⬛'];
        const positions = [];

        for (let i = 0; i < totalIcons; i++) {
          const isLeft = i < totalIcons / 2;
          positions.push({
            id: `${isLeft ? 'left' : 'right'}-${i}`,
            icon: icons[Math.floor(Math.random() * icons.length)],
            left: isLeft ?
              (2 + Math.random() * 15) :
              (70 + Math.random() * (30 - 3)),
            top: 5 + Math.random() * 90,
            size: Math.random() * 1.2 + 0.8, // 进一步减小尺寸
            duration: Math.random() * 15 + 10,
            delay: Math.random() * 5
          });
        }

        setFloatingIcons(positions);
      }, []);

      const loadLeaderboard = async () => {
        console.log('Loading leaderboard...');

        // 先尝试Firebase
        if (db && firebaseInitialized) {
          try {
            const snapshot = await db.collection('scores')
              .orderBy('moves')
              .orderBy('time')
              .limit(50)
              .get();

            const scores = [];
            snapshot.forEach(doc => {
              const data = doc.data();
              scores.push({
                ...data,
                id: doc.id,
                timestamp: data.timestamp || Date.now()
              });
            });

            console.log('Firebase scores loaded:', scores.length);
            setLeaderboard(scores);
            return;
          } catch (error) {
            console.error('Error loading Firebase leaderboard:', error);
            console.log('Falling back to local storage...');
          }
        }

        // Fallback to local storage
        loadLocalLeaderboard();
      };

      const loadLocalLeaderboard = () => {
        try {
          const stored = localStorage.getItem('spooky_leaderboard');
          if (stored) {
            const scores = JSON.parse(stored);
            scores.sort((a, b) => {
              if (a.moves !== b.moves) return a.moves - b.moves;
              return a.time - b.time;
            });
            console.log('Local scores loaded:', scores.length);
            setLeaderboard(scores);
          } else {
            setLeaderboard([]);
          }
        } catch (error) {
          console.error('Error loading local leaderboard:', error);
          setLeaderboard([]);
        }
      };

      const checkWin = (currentTiles) => {
        return currentTiles.every((tile, index) => tile === index);
      };

      const getEmptyIndex = (currentTiles) => {
        return currentTiles.indexOf(8);
      };

      const canMove = (tileIndex, emptyIndex) => {
        const tileRow = Math.floor(tileIndex / 3);
        const tileCol = tileIndex % 3;
        const emptyRow = Math.floor(emptyIndex / 3);
        const emptyCol = emptyIndex % 3;

        return (
          (Math.abs(tileRow - emptyRow) === 1 && tileCol === emptyCol) ||
          (Math.abs(tileCol - emptyCol) === 1 && tileRow === emptyRow)
        );
      };

      const handleTileClick = (index) => {
        if (isWon) return;

        const emptyIndex = getEmptyIndex(tiles);

        if (canMove(index, emptyIndex)) {
          const newTiles = [...tiles];
          [newTiles[index], newTiles[emptyIndex]] = [newTiles[emptyIndex], newTiles[index]];
          setTiles(newTiles);
          setMoves(moves + 1);

          setAnimatingTile(emptyIndex);
          setTimeout(() => setAnimatingTile(null), 300);

          if (checkWin(newTiles)) {
            const endTime = Date.now();
            const timeTaken = Math.floor((endTime - startTime) / 1000);
            setCompletionTime(timeTaken);
            setIsWon(true);
            setShowNameInput(true);
          }
        }
      };

      const shuffleTiles = () => {
        let shuffled = [...tiles];

        for (let i = 0; i < 100; i++) {
          const emptyIndex = shuffled.indexOf(8);
          const validMoves = [];

          const row = Math.floor(emptyIndex / 3);
          const col = emptyIndex % 3;

          if (row > 0) validMoves.push(emptyIndex - 3);
          if (row < 2) validMoves.push(emptyIndex + 3);
          if (col > 0) validMoves.push(emptyIndex - 1);
          if (col < 2) validMoves.push(emptyIndex + 1);

          const randomMove = validMoves[Math.floor(Math.random() * validMoves.length)];
          [shuffled[emptyIndex], shuffled[randomMove]] = [shuffled[randomMove], shuffled[emptyIndex]];
        }

        setTiles(shuffled);
        setMoves(0);
        setIsWon(false);
        setStartTime(Date.now());
        setShowNameInput(false);
      };

      const resetPuzzle = () => {
        setTiles([0, 1, 2, 3, 4, 5, 6, 7, 8]);
        setMoves(0);
        setIsWon(false);
        setStartTime(null);
        setShowNameInput(false);
      };

      const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            setImage(event.target.result);
            resetPuzzle();
          };
          reader.readAsDataURL(file);
        }
      };

      // 检查成绩是否更好
      const isScoreBetter = (existingScore, newScore) => {
        if (newScore.moves < existingScore.moves) return true;
        if (newScore.moves === existingScore.moves && newScore.time < existingScore.time) return true;
        return false;
      };

      const saveScore = async () => {
        if (!playerName.trim()) {
            alert('Please enter your name! 👻');
            return;
        }

        const scoreData = {
            name: playerName.trim(),
            moves: moves,
            time: completionTime,
            timestamp: Date.now()
        };

        console.log('Saving score:', scoreData);

        // Try Firebase first
        if (db && firebaseInitialized) {
            try {
                // 检查是否已存在同名用户
                const existingScoresQuery = await db.collection('scores')
                    .where('name', '==', playerName.trim())
                    .get();

                let shouldSave = true;

                if (!existingScoresQuery.empty) {
                    // 找到同名用户的最佳成绩
                    let bestExistingScore = null;
                    existingScoresQuery.forEach(doc => {
                        const data = doc.data();
                        if (!bestExistingScore || isScoreBetter(bestExistingScore, data)) {
                            bestExistingScore = data;
                        }
                    });

                    // 比较新成绩和现有最佳成绩
                    if (bestExistingScore && !isScoreBetter(bestExistingScore, scoreData)) {
                        // 新成绩不比现有成绩好，不保存
                        shouldSave = false;
                        alert(`⚠️ You already have a better score: ${bestExistingScore.moves} moves in ${formatTime(bestExistingScore.time)}. This score was not saved.`);
                    } else {
                        // 新成绩更好，删除所有旧成绩
                        const batch = db.batch();
                        existingScoresQuery.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                    }
                }

                if (shouldSave) {
                    await db.collection('scores').add(scoreData);
                    setShowNameInput(false);
                    setPlayerName('');

                    // 立即重新加载排行榜
                    await loadLeaderboard();
                    setShowLeaderboard(true);

                    alert('🎉 Score saved to GLOBAL leaderboard! Everyone can see your achievement! 🏆');
                }
                return;
            } catch (error) {
                console.error('Failed to save to Firebase:', error);
                alert('⚠️ Could not save to global leaderboard. Saving locally instead...');
            }
        }

        // Fallback to local storage
        try {
            const stored = localStorage.getItem('spooky_leaderboard');
            let scores = stored ? JSON.parse(stored) : [];

            // 查找同名用户的现有成绩
            const existingScores = scores.filter(score => score.name === playerName.trim());
            let shouldSave = true;

            if (existingScores.length > 0) {
                // 找到同名用户的最佳成绩
                let bestExistingScore = existingScores[0];
                existingScores.forEach(score => {
                    if (isScoreBetter(score, bestExistingScore)) {
                        bestExistingScore = score;
                    }
                });

                // 比较新成绩和现有最佳成绩
                if (!isScoreBetter(bestExistingScore, scoreData)) {
                    // 新成绩不比现有成绩好，不保存
                    shouldSave = false;
                    alert(`⚠️ You already have a better score: ${bestExistingScore.moves} moves in ${formatTime(bestExistingScore.time)}. This score was not saved.`);
                } else {
                    // 新成绩更好，删除所有旧成绩
                    scores = scores.filter(score => score.name !== playerName.trim());
                }
            }

            if (shouldSave) {
                scores.push(scoreData);

                // 确保正确排序
                scores.sort((a, b) => {
                    if (a.moves !== b.moves) return a.moves - b.moves;
                    return a.time - b.time;
                });

                // 只保留前50名
                const topScores = scores.slice(0, 50);

                localStorage.setItem('spooky_leaderboard', JSON.stringify(topScores));
                setShowNameInput(false);
                setPlayerName('');

                // 立即更新本地排行榜
                setLeaderboard(topScores);
                setShowLeaderboard(true);

                alert('🎉 Score saved locally! (Only you can see this score)');
            }
        } catch (error) {
            console.error('Failed to save score:', error);
            alert('❌ Failed to save score. Please try again.');
        }
      };

      const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      };

      const getTileStyle = (tileNumber) => {
        if (tileNumber === 8) return {};

        const row = Math.floor(tileNumber / 3);
        const col = tileNumber % 3;

        return {
          backgroundImage: image ? `url(${image})` : 'linear-gradient(135deg, #ff6b35 0%, #8b0000 100%)',
          backgroundSize: '300%',
          backgroundPosition: `${col * 50}% ${row * 50}%`,
        };
      };

      return (
        // 修改：减少外部空间，使用更紧凑的布局
        <div className="min-h-full flex flex-col items-center p-1 py-2 game-container">
          {floatingIcons.map((item) => (
            <div
              key={item.id}
              className="fixed animate-pulse opacity-20 pointer-events-none"
              style={{
                left: `${item.left}%`,
                top: `${item.top}%`,
                fontSize: `${item.size}rem`,
                animation: `float ${item.duration}s ease-in-out infinite`,
                animationDelay: `${item.delay}s`,
              }}
            >
              {item.icon}
            </div>
          ))}

          {/* 修改：添加puzzle-container类，减少边距，增加内部滚动 */}
          <div className="puzzle-container bg-gradient-to-br from-gray-900 to-black rounded-2xl shadow-2xl p-3 md:p-4 max-w-md w-full border-4 border-orange-600 relative z-10 my-1">
            <div className="absolute top-0 left-0 text-6xl opacity-40 animate-pulse">🕸️</div>
            <div className="absolute top-0 right-0 text-6xl opacity-40 transform scale-x-[-1] animate-pulse">🕸️</div>
            <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 text-4xl" style={{animation: 'shake 2s ease-in-out infinite'}}>🕷️</div>

            <div className="absolute -top-2 -left-2 text-3xl animate-bounce">🎃</div>
            <div className="absolute -top-2 -right-2 text-3xl animate-bounce" style={{animationDelay: '0.5s'}}>👻</div>
            <div className="absolute -bottom-2 -left-2 text-3xl animate-bounce" style={{animationDelay: '1s'}}>💀</div>
            <div className="absolute -bottom-2 -right-2 text-3xl animate-bounce" style={{animationDelay: '1.5s'}}>🦇</div>

            <h1 className="text-3xl font-bold text-center mb-1 text-orange-500 drop-shadow-lg animate-pulse" style={{fontFamily: 'Georgia, serif', textShadow: '0 0 20px rgba(255, 107, 53, 0.8)'}}>
              🎃 Spooky Puzzle 🎃
            </h1>
            <p className="text-center text-orange-300 mb-1 text-xs italic animate-pulse">
              Dare to solve it... if you can! 👻
            </p>
            {!firebaseInitialized && (
              <p className="text-center text-yellow-400 text-xs mb-2 bg-black bg-opacity-40 rounded px-2 py-1">
                ℹ️ Local mode - Configure Firebase for global leaderboard
              </p>
            )}
            {firebaseInitialized && (
              <p className="text-center text-green-400 text-xs mb-2 bg-black bg-opacity-40 rounded px-2 py-1">
                🌍 Global leaderboard active!
              </p>
            )}

            <div className="mb-3 flex flex-col gap-2">
              <input
                ref={fileInputRef}
                type="file"
                accept="image/*"
                onChange={handleImageUpload}
                className="hidden"
              />
              <button
                onClick={() => fileInputRef.current.click()}
                className="w-full bg-gradient-to-r from-purple-600 to-purple-800 hover:from-purple-700 hover:to-purple-900 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2 border-2 border-purple-400 shadow-lg hover:shadow-purple-500 hover:scale-105 active:scale-95 text-sm"
              >
                📤 Upload Spooky Image 👻
              </button>

              <div className="flex gap-2">
                <button
                  onClick={shuffleTiles}
                  className="flex-1 bg-gradient-to-r from-orange-600 to-orange-800 hover:from-orange-700 hover:to-orange-900 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2 border-2 border-orange-400 shadow-lg hover:shadow-orange-500 hover:scale-105 active:scale-95 text-sm"
                >
                  🔀 Haunt 🎃
                </button>
                <button
                  onClick={resetPuzzle}
                  className="flex-1 bg-gradient-to-r from-gray-600 to-gray-800 hover:from-gray-700 hover:to-gray-900 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2 border-2 border-gray-400 shadow-lg hover:shadow-gray-500 hover:scale-105 active:scale-95 text-sm"
                >
                  ↺ Reset 🦇
                </button>
              </div>

              <button
                onClick={() => setShowLeaderboard(!showLeaderboard)}
                className="w-full bg-gradient-to-r from-yellow-600 to-yellow-800 hover:from-yellow-700 hover:to-yellow-900 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2 border-2 border-yellow-400 shadow-lg hover:shadow-yellow-500 hover:scale-105 active:scale-95 text-sm"
              >
                🏆 {showLeaderboard ? 'Hide' : 'Show'} Leaderboard 🏆
              </button>
            </div>

            {showLeaderboard && (
              <div className="mb-2 bg-black bg-opacity-80 rounded-lg p-2 border-2 border-yellow-500 max-h-32 overflow-y-auto">
                <h3 className="text-lg font-bold text-yellow-400 text-center mb-1 flex items-center justify-center gap-2">
                  🏆 Hall of Fame 🏆
                </h3>
                {leaderboard.length === 0 ? (
                  <p className="text-gray-400 text-center text-xs">No scores yet. Be the first! 👻</p>
                ) : (
                  <div className="space-y-1">
                    {leaderboard.slice(0, 5).map((score, index) => (
                      <div
                        key={score.id || score.timestamp || index}
                        className={`flex items-center justify-between p-1 rounded text-xs ${
                          index === 0
                            ? 'bg-yellow-900 border-2 border-yellow-400'
                            : index === 1
                            ? 'bg-gray-700 border-2 border-gray-400'
                            : index === 2
                            ? 'bg-orange-900 border-2 border-orange-400'
                            : 'bg-gray-800 border border-gray-600'
                        }`}
                      >
                        <div className="flex items-center gap-1">
                          <span className="font-bold text-white">
                            {index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `#${index + 1}`}
                          </span>
                          <span className="text-white font-semibold">{score.name}</span>
                        </div>
                        <div className="flex items-center gap-1">
                          <span className="text-orange-300">{score.moves} moves</span>
                          <span className="text-blue-300">⏱️ {formatTime(score.time)}</span>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            <div className="mb-2 text-center bg-black bg-opacity-50 rounded-lg p-1 border-2 border-orange-500 relative overflow-hidden">
              <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-orange-500 to-transparent animate-pulse"></div>
              <span className="text-md font-bold text-orange-400 flex items-center justify-center gap-2">
                <span className="animate-pulse">👁️</span>
                Moves: <span className="text-orange-300 text-lg">{moves}</span>
                <span className="animate-pulse">👁️</span>
              </span>
              <div className="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-orange-500 to-transparent animate-pulse"></div>
            </div>

            {isWon && showNameInput && (
              <div className="mb-2 bg-gradient-to-r from-green-900 to-green-800 border-4 border-green-500 rounded-lg p-2 text-center shadow-xl relative overflow-hidden">
                <p className="text-green-300 font-bold text-lg">🎉 BOO-tiful! 🎉</p>
                <p className="text-green-200 text-sm mt-1">You escaped in {moves} moves!</p>
                <p className="text-blue-200 text-xs mt-1 flex items-center justify-center gap-1">
                  ⏱️ Time: {formatTime(completionTime)}
                </p>
                <p className="text-yellow-300 text-xl mt-1 mb-2">🏆👻🦇🎃💀</p>

                <div className="mt-1">
                  <input
                    type="text"
                    placeholder="Enter your name..."
                    value={playerName}
                    onChange={(e) => setPlayerName(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && saveScore()}
                    className="w-full px-2 py-1 rounded-lg bg-black bg-opacity-50 text-white border-2 border-green-400 placeholder-gray-400 focus:outline-none focus:border-green-300 mb-1 text-sm"
                    maxLength={20}
                    autoFocus
                  />
                  <button
                    onClick={saveScore}
                    className="w-full bg-gradient-to-r from-green-600 to-green-800 hover:from-green-700 hover:to-green-900 text-white font-bold py-1 px-4 rounded-lg transition-all border-2 border-green-400 hover:scale-105 active:scale-95 text-sm"
                  >
                    Save Score to Hall of Fame! 🏆
                  </button>
                </div>
              </div>
            )}

            {isWon && !showNameInput && (
              <div className="mb-2 bg-gradient-to-r from-green-900 to-green-800 border-4 border-green-500 rounded-lg p-2 text-center shadow-xl relative overflow-hidden">
                <p className="text-green-300 font-bold text-lg">Score Saved! 🎉</p>
                <p className="text-yellow-300 text-xl mt-1">🏆👻🦇🎃💀</p>
              </div>
            )}

            {/* 游戏板 - 禁止左右滑动，根据屏幕尺寸自动调整 */}
            <div
              ref={puzzleBoardRef}
              className="puzzle-board grid grid-cols-3 gap-1 bg-black bg-opacity-60 p-2 rounded-xl border-4 border-orange-700 shadow-2xl relative mx-auto"
            >
              <div className="absolute -top-1 -left-1 text-xl animate-spin" style={{animationDuration: '10s'}}>🕸️</div>
              <div className="absolute -top-1 -right-1 text-xl animate-spin" style={{animationDuration: '8s', animationDirection: 'reverse'}}>🕸️</div>

              {tiles.map((tile, index) => (
                <div
                  key={index}
                  onClick={() => handleTileClick(index)}
                  onTouchStart={(e) => {
                    // 不再阻止默认行为，允许触摸滚动
                    handleTileClick(index);
                  }}
                  className={`puzzle-tile aspect-square rounded-lg flex items-center justify-center text-xl font-bold transition-all gpu-accelerated no-select tile-active ${
                    tile === 8
                      ? 'bg-gray-900 cursor-default border-2 border-orange-800'
                      : 'bg-white cursor-pointer hover:scale-110 hover:rotate-3 max-md:tile-hover-disable shadow-md hover:shadow-2xl border-2 border-orange-600 hover:border-orange-400'
                  } ${animatingTile === index ? 'blood-slide' : ''}`}
                  style={getTileStyle(tile)}
                >
                  {!image && tile !== 8 && (
                    <span className="text-white drop-shadow-lg text-xl animate-pulse" style={{textShadow: '2px 2px 8px black, 0 0 10px orange'}}>
                      {tile + 1}
                    </span>
                  )}
                </div>
              ))}

              <div className="absolute -bottom-1 -left-1 text-lg animate-bounce">🦇</div>
              <div className="absolute -bottom-1 -right-1 text-lg animate-bounce" style={{animationDelay: '0.5s'}}>🐈‍⬛</div>
            </div>

            <div className="mt-2 text-center text-xs text-orange-200 italic flex items-center justify-center gap-1 animate-pulse">
              <span className="text-md">🕷️</span>
              Click tiles near the void to move them
              <span className="text-md">🕷️</span>
            </div>

            <div className="mt-1 flex justify-center gap-2 text-xl">
              <span className="animate-bounce">🍬</span>
              <span className="animate-bounce" style={{animationDelay: '0.2s'}}>🍭</span>
              <span className="animate-bounce" style={{animationDelay: '0.4s'}}>🎃</span>
              <span className="animate-bounce" style={{animationDelay: '0.6s'}}>👻</span>
              <span className="animate-bounce" style={{animationDelay: '0.8s'}}>🦇</span>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<SlidingPuzzle />, document.getElementById('root'));
    </script>
</body>
</html>